---
title: "Helmìœ¼ë¡œ í†µí•© ë°°í¬ ì†”ë£¨ì…˜ êµ¬í˜„í•˜ê¸° (with Golang, Harbor)"
date: "2025-03-23"
description: "ì´ë²ˆ ê²Œì‹œê¸€ì€ Helmì— ëŒ€í•´ ë‹¤ë£¬ë‹¤. ì´ 6ì¼ê°„ ì‚¬ë‚´ ì†”ë£¨ì…˜ ì„¤ì¹˜ ë°©ì‹ì— elm Chartì™€ Helm Repositoryë¥¼ ì ìš©í•˜ì˜€ìœ¼ë©°, cspë³„ K8s ë¦¬ì†ŒìŠ¤ í†µí•© ê³¼ì •ê³¼ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í¬í•¨í•œ ê¸°ìˆ  ì„¸ì…˜ ê³µìœ ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. ì†”ë£¨ì…˜ì˜ ì²«ì¸ìƒê³¼ë„ ê°™ì€ ì„¤ì¹˜ ì„œë¹„ìŠ¤ê°€ ì •ëˆë˜ê³ , ë¶ˆí¸í•œ ì™¸ë¶€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ê±·ì–´ë‚´ëŠ” ìœ ì˜ë¯¸í•œ ì‹œê°„ì´ì—ˆë‹¤."
thumbnail: "thumbnail.png"
category: "Productivity"
subcategory: "Deployment"
tags: []
---

## ë“¤ì–´ê°€ë©°

ì´ë²ˆ ê²Œì‹œê¸€ì€ Helmì— ëŒ€í•´ ë‹¤ë£¬ë‹¤. ì´ 6ì¼ê°„ ì‚¬ë‚´ ì†”ë£¨ì…˜ ì„¤ì¹˜ ë°©ì‹ì— Helm Chartì™€ Helm Repositoryë¥¼ ì ìš©í•˜ì˜€ìœ¼ë©°, cspë³„ K8s ë¦¬ì†ŒìŠ¤ í†µí•© ê³¼ì •ê³¼ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í¬í•¨í•œ ê¸°ìˆ  ì„¸ì…˜ ê³µìœ ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. ì†”ë£¨ì…˜ì˜ ì²«ì¸ìƒê³¼ë„ ê°™ì€ ì„¤ì¹˜ ì„œë¹„ìŠ¤ê°€ ì •ëˆë˜ê³ , ë¶ˆí¸í•œ ì™¸ë¶€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ê±·ì–´ë‚´ëŠ” ìœ ì˜ë¯¸í•œ ì‹œê°„ì´ì—ˆë‹¤.

![ë°°ì˜ ìš´ì „ëŒ€, í‚¤ë¥¼ ì˜ë¯¸í•˜ëŠ” Helm](https://0biglife-world.s3.us-east-2.amazonaws.com/post24_01.png)

## Helm

Helmì€ **Kubernetes íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €**ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ë¥¼ ì‰½ê³  íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ë‹¤. Node.jsë¡œ ì¹˜ë©´ Npmì´ë¼ê³  ìƒê°í•˜ë©´ ì´í•´ê°€ ì‰½ë‹¤. ì¥ì ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. **íŒ¨í‚¤ì§• ë° ë°°í¬**: ì—¬ëŸ¬ YAML íŒŒì¼(Deployment, Service, ConfigMap ë“±)ì„ í•˜ë‚˜ì˜ íŒ¨í‚¤ì§€(Helm Chart)ë¡œ ê´€ë¦¬í•˜ì—¬, ë³µì¡í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í•œ ë²ˆì— ë°°í¬ ê°€ëŠ¥í•˜ê²Œ í•´ì¤€ë‹¤.

2. **ë²„ì „ ê´€ë¦¬**: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë²„ì „ì„ ê´€ë¦¬í•˜ê³ , ë¡¤ë°±(rollback) ê¸°ëŠ¥ì„ ì§€ì›í•˜ì—¬ ì•ˆì •ì ì¸ ë°°í¬ë¥¼ ë³´ì¥í•œë‹¤.

3. **í…œí”Œë¦¿í™”**: Helm Chart í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì–‘í•œ í™˜ê²½(ê°œë°œ, í…ŒìŠ¤íŠ¸, ìš´ì˜)ì— ë§ê²Œ êµ¬ì„±ê°’ì„ ë™ì ìœ¼ë¡œ ì£¼ì…í•˜ì—¬ ê´€ë¦¬í•œë‹¤.

## Helm Chartë€

Helmì„ ì‚¬ìš©í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ê¸° ìœ„í•œ **íŒ¨í‚¤ì§€ íŒŒì… ì§‘í•©** ê°œë…ì´ë‹¤. ì´ëŠ” Kubernetes ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿ íŒŒì¼ê³¼ Chart ìì²´ì— ëŒ€í•œ ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨í•œë‹¤.

### êµ¬ì„±ìš”ì†Œ

- **Chart.yaml**: Chartì˜ ì´ë¦„, ë²„ì „, ì„¤ëª… ë“±ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë‹´ê³  ìˆë‹¤.

- **values.yaml**: í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©ë  ê¸°ë³¸ ì„¤ì •ê°’ë“¤ì„ ì •ì˜í•œë‹¤.

- **templates/**: ì‹¤ì œ Kubernetes ë¦¬ì†ŒìŠ¤(Deployment, Service ë“±)ë¥¼ ì •ì˜í•˜ëŠ” YAML í…œí”Œë¦¿ íŒŒì¼ë“¤ì„ ê´€ë¦¬í•œë‹¤.

í•„ìëŠ” CSPë³„ ë‹¤ë¥¸ ì†ì„±ê°’ë“¤ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ `values-*` íŒŒì¼ì„ í†µí•´ ê´€ë¦¬í•˜ë ¤ê³  í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `values-aks.yaml`, `values-eks.yaml`, `values-nks.yaml` ë“± ì¶”ê°€ ì„¤ì • íŒŒì¼ì„ ì¶”ê°€í•˜ì—¬ ê° CSPë³„ ì¸ìë“¤, ì´ë¥¼í…Œë©´ StorageClassì˜ `provisioner`, `parameters` ì†ì„±ë“¤ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ, Helm Chartë¥¼ í†µí•´ ìš°ë¦¬ëŠ” ë³µì¡í•œ Kubernetes ë°°í¬ êµ¬ì„±ì„ ë‹¨ìˆœí™”í•˜ê³ , ë™ì¼í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ë‹¨ì¼ ì°¨íŠ¸ë¥¼ í†µí•´ ë°°í¬ ê´€ë¦¬í•˜ë ¤ëŠ” ê²ƒì´ë‹¤.

## ê°œë°œ ìš”êµ¬ì‚¬í•­

ë‹¤ìŒ ìš”ê±´ì„ ì¶©ì¡±ì‹œí‚¤ìëŠ” ëª©í‘œë¡œ ì‹œì‘í–ˆë‹¤.

1. cspë³„ ì„œë¡œ ë‹¤ë¥¸ yaml íŒŒì¼ ê´€ë¦¬ë¥¼ `Helm`ì„ í†µí•´ í†µí•©í•œë‹¤.

2. ì„¤ì¹˜ ê³¼ì •ì—ì„œ Helmì„ ì„¤ì¹˜í•˜ì§€ ì•Šê³ , `go-client-helm` SDKë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì‚¬ìš©ì PCì˜ Helm ë²„ì „ ì˜ì¡´ì„±ì„ ì™„ë²½í•˜ê²Œ ë¶„ë¦¬í•˜ì—¬ ì„¤ì¹˜ë¥¼ ì§„í–‰í•œë‹¤. (ë‹¹ì—°íˆ ì¸ìŠ¤í„´ìŠ¤ ë©”ëª¨ë¦¬ëŠ” ì‹¤í–‰ ì¢…ë£Œì‹œ ìë™ í•´ì œëœë‹¤.)

3. ë§Œë“¤ì–´ì§„ `Helm` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ ë¡œì§ì„ ê°„ì†Œí™”, ìœ ì§€ë³´ìˆ˜ í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, Ciliumê³¼ Istioë¥¼ ì„¤ì¹˜í•˜ëŠ” í•¨ìˆ˜ëŠ” `root/helm/installer.go`ë¡œ ë¶„ë¦¬í•˜ì—¬ í•„ìš”í•  ë•Œ ê°€ì ¸ë‹¤ì“´ë‹¤.

4. `Helm Chart`ë¡œ í†µí•©ë  yaml ê´€ë¦¬ë¥¼ í†µí•´ ì™¸ë¶€ ë ˆì§€ìŠ¤íŠ¸ë¦¬(wasabi)ë¥¼ ì™„ì „íˆ ê±·ì–´ë‚¸ë‹¤.

5. ì´ ê³¼ì •ì—ì„œ ë°œìƒë˜ëŠ” ëª¨ë“  í•¨ìˆ˜ëŠ” ë‹¨ì¼ ì›ì¹™ì„ ë”°ë¥´ê³ , í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ì—¬ ê´€ë¦¬í•œë‹¤.

ì´ ê³¼ì •ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ ê°€ì¥ ë¨¼ì € `go-client-helm` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“œëŠ” ê²ƒë¶€í„° ì‹œì‘í–ˆë‹¤.

#### Go Client Helm

ë‹¤ì‹œ ë§í•´ í•„ìëŠ” í˜„ì¬ Golangìœ¼ë¡œ ì„¤ì¹˜ í”„ë¡œê·¸ë¨ì„ ê°œë°œ ì¤‘ì´ë©° ì„¤ì¹˜í•˜ë ¤ëŠ” ë¡œì»¬ PCì— Helm ì„¤ì¹˜ ì—¬ë¶€ì™€ëŠ” ë…ë¦½ì ìœ¼ë¡œ ê°œë°œí•˜ê¸° ìœ„í•˜ì—¬ `go-helm-client`ë¥¼ ì‚¬ìš© ì¤‘ì´ë‹¤.(ì´ëŠ” Helm v2,v3ê°€ ë³´ì•ˆë¬¸ì œë¡œ ì¸í•˜ì—¬ RBAC ê´€ë¦¬ ë°©ì‹ì´ ë°”ë€ŒëŠ” ê²ƒì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê¸° ìœ„í•¨ì´ë©°, ë™ì‹œì— ì„¤ì¹˜ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ì¡´ì„±ì€ ì„¤ì¹˜ ì¢…ë£Œì™€ ë™ì‹œì— ì œê±°ë˜ì–´ì•¼í•¨ì„ ë³´ì¥í•˜ê¸° ìœ„í•¨ì´ë‹¤.) ì‚¬ìš©ë²•ì€ ê°„ëµíˆ ë‹¤ìŒê³¼ ê°™ë‹¤.

```go
helmClient, err := helmclient.New(opt)
if err != nil {
  return fmt.Errorf("helm client creation failed: %w", err)
}

customValuesYaml := `
global:
  csp: nks
  namespace: test-system

  mongodb:
    registrySecretName: ncr-secret

base:
  enabled: false  # base ì»´í¬ë„ŒíŠ¸ í™œì„±í™”
main:
  enabled: true   # main ì»´í¬ë„ŒíŠ¸ í™œì„±í™”
`

ChartSpec := &helmclient.ChartSpec{
  ChartName:       "oci://{harbor-url}/{project-name}/{chart-name}",  // OCI ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì°¨íŠ¸ ìœ„ì¹˜
  Version:         "1.0.0",                                           // ì°¨íŠ¸ ë²„ì „
  ReleaseName:     {release-name},                                    // ë¦´ë¦¬ìŠ¤ ì´ë¦„
  Namespace:       {namespace},                                       // ì„¤ì¹˜ë  ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  Wait:            true,                                              // ë¦¬ì†ŒìŠ¤ Ready ìƒíƒœ ëŒ€ê¸°
  Timeout:         time.Minute * 10,                                  // ì„¤ì¹˜ íƒ€ì„ì•„ì›ƒ
  CreateNamespace: true,                                              // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìë™ ìƒì„± ë¹„í™œì„±í™”
  ValuesYaml:      customValuesYaml,                                  // ì°¨íŠ¸ values ì„¤ì •
}

fmt.Println("ğŸš€ Starting Custom Chart Installation...")
if _, err := helmClient.InstallOrUpgradeChart(context.Background(), ChartSpec, nil); err != nil {
  return err
}
```

ìœ„ì™€ ê°™ì´ `helmclient`ë¼ëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì¬ì‚¬ìš©í•œë‹¤. `customValuesYaml`ì—ì„œëŠ” `global` ì†ì„±ì„ í†µí•´ `csp`ì™€ ê° cspë³„ ë‹¤ë¥´ê²Œ ê´€ë¦¬í•˜ê³  ì‹¶ì€ ì†ì„±ê°’ë“¤ì„ ëª…ì‹œí•´ì£¼ê³  ì¸ìŠ¤í„´ìŠ¤ì˜ ì°¨íŠ¸ ìŠ¤í™ì˜ `ValuesYaml`ì— ë„£ì–´ì¤€ë‹¤. ì°¨íŠ¸ ì´ë¦„ê³¼ `Wait`ì€ ì•„ë˜ì„œ ì„¤ëª…í•  ì˜ˆì •ì´ë©°, `Timeout`ì€ í˜„ì¬ ì°¨íŠ¸ ì„¤ì¹˜í•˜ëŠ” íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ ì§€ì •í•˜ëŠ” ê°’ì´ë‹¤. `CreateNamespace`ëŠ” ì„¤ì¹˜í•˜ë ¤ëŠ” ë¦¬ì†ŒìŠ¤ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±ì„ ë¨¼ì € ì§„í–‰í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.

Helmì˜ ìš©ë„ì™€ êµ¬ì„±ì€ ì•Œê² ê³  ì´ì   ë‚´ê°€ ì›í•˜ëŠ” ì˜ë„ì— ë§ê²Œ ë™ì‘í•˜ê²Œ í•´ì•¼í•œë‹¤. ì´ë¥¼ ìœ„í•œ ê³ ë¯¼í•´ì•¼í•  í° ë§¥ë½ì€ ë‹¤ìŒ ë‘ ê°€ì§€ë¡œ ì •ë¦¬í–ˆë‹¤.

#### 1. cspë³„ í•„ìš”í•œ ì†ì„±ê°’ ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ ì´ë£¨ì–´ì§€ëŠ”ê°€?

`Helm` ê³ ìœ ì˜ yaml ê´€ë¦¬ ë¬¸ë²•(í•„ìëŠ” ë¬¸ë²•ì´ë¼ê³  í‘œí˜„í•˜ê² ë‹¤)ì´ ì²˜ìŒì—” ìµìˆ™í•˜ì§€ ì•Šì•˜ìœ¼ë‚˜, ì“¸ìˆ˜ë¡ í¸ë¦¬í–ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì¸ìë¡œ `custom.*`ë¥¼ ë„˜ê²¨ì£¼ê³  í•´ë‹¹ ê°’ì„ íŠ¹ì • yamlì—ì„œ ê°€ì ¸ë‹¤ ì“¸ ë•ŒëŠ” `{{ .Values.custom.frontendImage }}` ë°©ì‹ìœ¼ë¡œ ê°€ì ¸ë‹¤ ì“´ë‹¤.

```yaml
# Deployment/yaml
containers:
  - name: frontend
    image: { { .Values.custom.frontendImage } }
    ports:
      - containerPort: 4173
        protocol: TCP
    resources:
      limits:
        cpu: "1"
        memory: 1000Mi
      requests:
        cpu: 250m
        memory: 1000Mi
```

ë˜ëŠ” yaml ë‚´ë¶€ì—ì„œ ì¡°ê±´ë¬¸ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. `global`ë¡œ ì„ ì–¸í•œ `csp` ì†ì„±ê°’ì´ `nks`ì¼ ë•Œì—ëŠ” ì´ yamlì„ ë°°í¬í•˜ì§€ ì•Šê² ë‹¤ëŠ” ì¡°ê±´ì„ ë‹¤ìŒê³¼ ê°™ì´ ê±¸ì–´ì¤„ ìˆ˜ ìˆë‹¤. ì‹¬ì§€ì–´, ìš°ë¦¬ê°€ ì—ëŸ¬ ë¡œê¹…ì„ ì°ì–´ë³´ë“¯ì´ yaml ë‚´ë¶€ì—ì„œ ê°’ì„ ë””ë²„ê¹…í•  ìˆ˜ë„ ìˆë‹¤.

```yaml
# StorageClass.yaml
{{- if ne .Values.global.csp "nks" }}
allowVolumeExpansion: true
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: test-storageclass
  namespace: test-system
  annotations:
    "helm.sh/hook-weight": "-16"
mountOptions:
  - dir_mode=0777
  - file_mode=0777
parameters:
{{- if .Values.storageClass.parameters }}
  {{- range $key, $value := .Values.storageClass.parameters }}
  {{ $key }}: {{ $value }}
  {{- end }}
{{- end }}
provisioner: {{ .Values.storageClass.provisioner }}
reclaimPolicy: Retain
volumeBindingMode: Immediate
{{- end }}
```

#### 2. ì„¤ì¹˜ ìˆœì„œë¥¼ ì–´ë–»ê²Œ ì ìš©í•˜ëŠ”ê°€?

Helmì€ Annotationì— `hook-weight`ë¥¼ ì§€ì •í•´ì¤Œìœ¼ë¡œì¨ **ìˆœì°¨ì ì¸ ë°°í¬ë¥¼ ë³´ì¥**í•œë‹¤. ì´ ìˆ«ìëŠ” ì‘ëŠ” ìˆ«ìì¼ìˆ˜ë¡ ìµœìš°ì„ ìœ¼ë¡œ ë°°í¬í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, A ë¦¬ì†ŒìŠ¤ëŠ” Bë¦¬ì†ŒìŠ¤ë³´ë‹¤ ë¨¼ì € ë°°í¬ëœë‹¤. ë˜í•œ, `helm.sh/resource-policy: keep`ê³¼ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì¬ë°°í¬ì‹œ ì˜í–¥ì„ ë°›ì„ì§€ ì—¬ë¶€ì— ëŒ€í•œ ê¸°ëŠ¥ë„ í¬í•¨í•œë‹¤. ì´ ë°–ì— ê¸°ëŠ¥ë“¤ì€ ë¬¸ì„œì—ì„œ í™•ì¸í•˜ì.

```yaml
# A Resource
  ...
  annotations:
    "helm.sh/hook-weight": "-6"
    "helm.sh/resource-policy": keep
  ...

# B Resource
  ...
  annotations:
    "helm.sh/hook-weight": "-2"
    "helm.sh/resource-policy": keep
  ...
```

**3. ì„¤ì¹˜ ë„ì¤‘ì— ë°œìƒí•˜ëŠ” DB Replia Setì„ PRIMARYë¡œ ì ìš©ì´ë‚˜ Pod Status ê²€ì¦ì€ ì–´ë–¤ ì‹ìœ¼ë¡œ ë™ì‘í•´ì•¼í•˜ëŠ”ê°€? ì„¤ì¹˜ë¥¼ ì¤‘ë‹¨í•´ì•¼í• ê¹Œ ì•„ë‹ˆë©´ waitì„ ê±¸ì–´ì£¼ëŠ” ê¸°ëŠ¥ì´ ì§€ì›ë˜ëŠ”ê°€?**

ë¨¼ì €, Pod Status ê²€ì¦ì— ëŒ€í•´ì„œëŠ” Helmì—ì„œ ìë™ìœ¼ë¡œ ê²€ì¦í•´ì¤€ë‹¤. `go-client-helm`ì˜ `helmclient`ì—ëŠ” `Wait` ê¸°ëŠ¥ì„ `true` ë˜ëŠ” `false`ë¡œ ì§€ì›í•´ì¤€ë‹¤. `true`ë¡œ ì„¤ì •í• ì§€ í˜„ì¬ ì„¤ì¹˜í•œ ì›Œí¬ë¡œë“œì˜ íŒŒë“œ ìƒíƒœê°€ `Ready`ê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì¤€ë‹¤ëŠ” ëœ»ì´ë‹¤.

```bash
...
2025/01/24 09:25:50 Service does not have load balancer ingress IP address: test-system/test
2025/01/24 09:25:52 Deployment is not ready: test-system/test. 0 out of 1 expected pods are ready
2025/01/24 09:25:54 Deployment is not ready: test-system/test. 0 out of 1 expected pods are ready
2025/01/24 09:25:56 Deployment is not ready: test-system/test. 0 out of 1 expected pods are ready
...
# ìœ„ì™€ ê°™ì´ ë””í´íŠ¸ 2ì´ˆì— í•œ ë²ˆì”© ëª¨ë‹ˆí„°ë§í•˜ê³  ìƒíƒœê°€ '1 out of 1'ì´ ë˜ë©´ ë‹¤ìŒ ì„¤ì¹˜ ê³¼ì •ìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.
```

ì •ë§ í¸ë¦¬í•˜ì§€ ì•Šë‚˜. ê³ ë§ˆì›Œ Helm.. ê·¸ ë‹¤ìŒì€ DB StatefulSetì´ ë°°í¬ê°€ ë˜ì—ˆê³ , ì†”ë£¨ì…˜ ì›Œí¬ë¡œë“œ íŒŒë“œê°€ ì„¤ì¹˜ë˜ê¸° ì „ì— ë°±ì—”ë“œ íŒŒë“œê°€ ì‹¤í–‰ë˜ë©´ì„œ DBì˜ PRIMARY PODë¥¼ ìš”ì²­í•´ì•¼í•œë‹¤. ì¦‰, ì„¤ì¹˜ ìˆœì„œ ì‚¬ì´ì— DB Replica Set ì„¤ì •ì„ ìœ„í•´ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì–´ì•¼í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ëŠ”ë°, ì´ë¥¼ ìœ„í•´ ì„œë¸Œì°¨íŠ¸ë¡œ ë¶„ë¦¬í•˜ì˜€ë‹¤. ë¬¼ë¡  `option`ì„ í†µí•´ ì œì–´í•  ìˆ˜ ìˆë‹¤ê³  í•˜ì§€ë§Œ, ê°œë°œ ë ˆë²¨ì—ì„œì˜ ë³µì¡ì„±ê³¼ ì°¨íŠ¸ ì•„í‚¤í…ì²˜ì˜ ë³µì¡ì„±ì— ëŒ€í•œ ë°¸ëŸ°ìŠ¤ë¥¼ ê³ ë¯¼í•œ ê²°ê³¼ `option`ì€ ì“°ì§€ ì•Šê³  Chartë¥¼ í•˜ë‚˜ ë” ë§Œë“œëŠ” ëŒ€ì‹  ì½”ë“œë¥¼ ê¹”ë”í•˜ê²Œ ê°€ì ¸ê°€ê¸°ë¡œ í–ˆë‹¤. ì´ëŠ” ì°¨íŠ¸ êµ¬ì„±ë„ê°€ ìµœëŒ€ 2ê°œê¹Œì§€ ê°€ì ¸ê°€ëŠ” ê²ƒì´ ë˜ë ¤ base subChart, main subChartë¡œ ë‚˜ë‰˜ì–´ì§€ëŠ” ë°ì„œ ë” ëª…ì‹œì ì¼ ê²ƒì´ë¼ íŒë‹¨í•œ ê²°ê³¼ì˜€ë‹¤.

ë”°ë¼ì„œ, í•„ìê°€ êµ¬ì„±í•œ **Helm Chart ì•„í‚¤í…ì²˜**ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```bash
# base Chart: jaeger, kube-state-metrics, monitoring, mongodb ë“± ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¥¼ ì •ì˜
# main Chart: ì‹¤ì œ ì„œë¹„ìŠ¤ ë°°í¬ë¥¼ ìœ„í•œ ì„¤ì •ì„ í¬í•¨ëœë‹¤.
# ì—¬ëŸ¬ values íŒŒì¼ì„ í†µí•´ AKS, EKS, NKS ë“± ë‹¤ì–‘í•œ í™˜ê²½ì— ë§ëŠ” ì„¤ì •ì„ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•œë‹¤.
# ì „ì²´ ì„¤ì¹˜ í”„ë¡œì„¸ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë‹¨ê³„ë³„ë¡œ ì§„í–‰ëœë‹¤.

{name}-chart/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ values.yaml
â”œâ”€â”€ values-aks.yaml
â”œâ”€â”€ values-eks.yaml
â”œâ”€â”€ values-nks.yaml
â””â”€â”€ charts/
    â”œâ”€â”€ base/
    â”‚   â”œâ”€â”€ Chart.yaml
    â”‚   â”œâ”€â”€ values.yaml
    â”‚   â””â”€â”€ templates/
    â”‚       â”œâ”€â”€ _helpers.tpl
    â”‚       â”œâ”€â”€ config/
    â”‚       â”‚   â””â”€â”€ config.yaml
    â”‚       â”œâ”€â”€ jaeger/
    â”‚       â”‚   â”œâ”€â”€ deployment.yaml
    â”‚       â”‚   â””â”€â”€ services.yaml
    â”‚       â”œâ”€â”€ kube-state-metrics/
    â”‚       â”‚   â”œâ”€â”€ deployment.yaml
    â”‚       â”‚   â”œâ”€â”€ ...
    â”‚       â”‚   â””â”€â”€ rbac.yaml
    â”‚       â”œâ”€â”€ monitoring/
    â”‚       â”‚   â”œâ”€â”€ namespace.yaml
    â”‚       â”‚   â”œâ”€â”€ ...
    â”‚       â”‚   â””â”€â”€ rbac.yaml
    â”‚       â”œâ”€â”€ storage/
    â”‚       â”‚   â”œâ”€â”€ storageclass.yaml
    â”‚       â”‚   â”œâ”€â”€ pv.yaml
    â”‚       â”‚   â””â”€â”€ pvc.yaml
    â”‚       â”œâ”€â”€ mongodb/
    â”‚       â”‚   â”œâ”€â”€ statefulset.yaml
    â”‚       â”‚   â”œâ”€â”€ ...
    â”‚       â”‚   â””â”€â”€ rbac.yaml
    â”‚       â””â”€â”€ log/
    â”‚           â””â”€â”€ ...
    â””â”€â”€ {main-chart-name}/
        â”œâ”€â”€ Chart.yaml
        â”œâ”€â”€ values.yaml
        â””â”€â”€ templates/
            â”œâ”€â”€ deployment.yaml
            â””â”€â”€ service.yaml
```

[Helm Doc](https://helm.sh/docs/chart_template_guide/subcharts_and_globals/)ì„ í†µí•´ SubChartë¥¼ ì‚¬ìš©í–ˆê³ , ìœ„ êµ¬ì„±ë„ë¥¼ í†µí•´ ìš°ë¦¬ëŠ” `base Chart` ì„¤ì¹˜ë¥¼ ë§ˆì¹œ ë’¤, íŠ¹ì • ë™ì‘ì„ ì™„ìˆ˜í•˜ê³  í•´ë‹¹ ë™ì‘ì´ ë§ˆì¹œ ë‹¤ìŒì—ì„œì•¼ `main Chart` ì„¤ì¹˜ë¥¼ ì§„í–‰í•  ê²ƒì´ë‹¤.

## Helm Repository

ì´ê±´ ë­˜ê¹Œ? ë§ê·¸ëŒ€ë¡œ **Helm Chartë¥¼ ì €ì¥í•˜ê³  ë°°í¬í•  ìˆ˜ ìˆëŠ” ì €ì¥ì†Œ**ë‹¤. Helmì„ ì ìš©í•˜ê¸° ì „ ìš°ë¦¬ íŒ€ì—ì„œëŠ” ì†”ë£¨ì…˜ ì„¤ì¹˜ë¥¼ ìœ„í•´ì„œ ê°€ì ¸ì™€ì•¼í•˜ëŠ” ë¦¬ì†ŒìŠ¤ yamlë“¤ì€ ì „ë¶€ <u>wasabi ë¼ëŠ” í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€</u>ì— ì˜¬ë¼ê°€ìˆì—ˆë‹¤. ê·¼ë˜ ì†”ë£¨ì…˜ ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ Harborë¡œ êµ¬ì¶•í•˜ë©´ì„œ ì´ë•Œë‹¤ ì‹¶ì–´ wasabië¥¼ ê±·ì–´ë‚´ê³  Harborë¡œ í†µí•©í•˜ê³ ì í–ˆë‹¤.

![Harbor Dashboard Page](https://0biglife-world.s3.us-east-2.amazonaws.com/post24_03.png)

**Harbor**ëŠ” **ì˜¤í”ˆì†ŒìŠ¤ ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬**ë¡œ, í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ í™˜ê²½ì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì™€ Helm Chartì™€ ê°™ì€ íŒ¨í‚¤ì§€ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ë‹¤. ì†”ë£¨ì…˜ë³„, CSPë³„ ì´ë¯¸ì§€ê°€ ëª¨ë‘ Harborì˜ í¼ë¸”ë¦­ í”„ë¡œì íŠ¸ì— ì˜¬ë¼ê°€ ìˆìœ¼ë©°, ì„¤ì¹˜ì— ê´€ì—¬í•˜ëŠ” Helm Chartë„ ëª¨ë‘ Harborì˜ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¡œ ì—…ë¡œë“œí•˜ì—¬ ê´€ë¦¬í•˜ë ¤ê³  í•œë‹¤. ì´ë ‡ê²Œ ë˜ë©´ ì¸ìŠ¤í†¨ í”„ë¡œì„¸ìŠ¤ì˜ 10êµ°ë° ë„˜ê²Œ ë“¤ì–´ê°„ wasabi urlë“¤ì€ ëª¨ë‘ ì œê±°ë  ìˆ˜ ìˆì—ˆê³  ì´ ì°¸ì— ì§€ì €ë¶„í•˜ê³  í†µí•©ë˜ì§€ ëª»í•œ í•¨ìˆ˜ë“¤ì„ ì „ë¶€ í†µí•©ì‹œí‚¤ê³  ë¦¬íŒ©í† ë§í•˜ì˜€ë‹¤.

![Helm Repository Diagram](https://0biglife-world.s3.us-east-2.amazonaws.com/post24_02.png)

ì •ë¦¬í•´ë³´ìë©´, Helmì„ í†µí•´ Helm Chartë¥¼ í”„ë¡œì íŠ¸ ëª©ì ì— ë§ê²Œ êµ¬ì¶•ì„ í•œ ë’¤, íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•˜ê³  Repositoryì— ì˜¬ë¦°ë‹¤. ê·¸ë¦¬ê³  ì„¤ì¹˜í•  ë•Œë§ˆë‹¤ ìš°ë¦¬ëŠ” Helmì„ ì‚¬ìš©í•´ Harborì—ì„œ Chartë¥¼ ê°€ì ¸ì˜¬ ê²ƒì´ê³ , ë¯¸ë¦¬ ë§Œë“¤ì–´ì¤€ Helm Chartë¥¼ í†µí•´ ì•Œì•„ì„œ yamlë“¤ì´ ë°°í¬ë˜ë„ë¡ ì˜ë„í•œë‹¤. ìœ„ ê·¸ë¦¼ì„ ì°¸ê³ í•˜ì.

## ìµœì¢… ì½”ë“œ

ìµœì¢… ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. `go-client-helm` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ê³ , Istioë¥¼ ì„¤ì¹˜í•œ ì´í›„, ì²« ë²ˆì§¸ ì„œë¸Œì°¨íŠ¸ì¸ `base-chart`ë¥¼ ì„¤ì¹˜í•œë‹¤. ì„¤ì¹˜ê°€ ì™„ë£Œëœ í›„ì— `Helm`ì—ì„œ DB Pod Status ìƒíƒœ ê²€ì¦ì„ ë§ˆì³¤ê¸° ë•Œë¬¸ì— ê³§ë°”ë¡œ DB Replica Set ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•œë‹¤. ì´ˆê¸°í™”ë¥¼ ë§ˆì¹˜ë©´ ì´ˆê¸°í™”ê°€ ì˜ ì§„í–‰ë˜ì—ˆëŠ”ì§€ 3ë¶„ì˜ íƒ€ì„ì•„ì›ƒê³¼ 5ì´ˆë§ˆë‹¤ `rs.status()`ë¥¼ ê²€ì¦í•˜ë©° í•¨ìˆ˜ë¥¼ ë§ˆì¹œë‹¤. ê·¸ ë‹¤ìŒì—ì„œì•¼ ì´ì œ ë‘ ë²ˆì§¸ ì„œë¸Œì°¨íŠ¸ì¸ `main-chart`ë¥¼ ì„¤ì¹˜í•œë‹¤. ì—¬ê¸°ê¹Œì§€ê°€ Helmì´ ê´€ì—¬í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë‹¤.

```go
package nks

var NewCmd = &cobra.Command{
Run: func(cmd *cobra.Command, args []string) {

  // ... ìƒëµ ...

  //* Helm í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
  helmInstaller, err := installer.NewInstaller("./charts")
  if err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Helm installer instance creation failed : %v", err)).Bold())
      os.Exit(1)
  }
  defer helmInstaller.Cleanup()

  //* Istio ì„¤ì¹˜
  if err := helmInstaller.InstallIstio("1.22.2"); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Istio Installation failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Install base chart
  if err := installBaseChart(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Base Chart Installation failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Initialize replica set
  if err := initializeReplicaSet(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Initialize Replica Set failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Initialize nks credential
  if err := initializeDBEnvironment(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Initialize Nks Credential Setting failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Install main chart
  if err := installMainChart(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Main Chart Installation failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Initialize Service Url
  if err := initializeServiceUrl(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Main Url Initialization failed : %v", err)).Bold())
    os.Exit(1)
  }

  //* Send Installation Confirmation Email
  if err := sendInstallationConfirmationEmail(); err != nil {
    fmt.Println(aurora.Red(fmt.Sprintf("âŒ Send Service Confirmation Email failed : %v", err)).Bold())
    os.Exit(1)
  }

  fmt.Println("âœ… NKS installation completed successfully!")
  os.Exit(1)
},
}
```

ì›ë˜ ì½”ë“œë¥¼ ì •ë¦¬í•˜ë©´ì„œ ì±…ìƒ ì •ë¦¬ë˜ë“¯í•œ í¬ì—´ì„ ëŠë‚€ë‹¤. ì—‰ë§ì´ì—ˆë˜ ì½”ë“œë“¤ì´ ë¸”ë¡í˜•íƒœë¡œ ë§ì¶°ì§€ëŠ” ì¾Œê°ì´ë€.. ì´ì œ ì € ëª¨ë“ˆë“¤ì„ cspë³„ ì›í•˜ëŠ” ê³¼ì •ë§ˆë‹¤ ë¼ì›Œë„£ê¸°ë§Œ í•˜ë©´ ëœë‹¤. ë¬¼ë¡  100% ì™„ë²½í•˜ì§€ ì•Šë‹¤. ì¶”ê°€ ê³ ë ¤ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ë¡œê¹… ê°œì„ 

2. ì—ëŸ¬ ëª¨ë“ˆí™”

3. execMongoDBCommand(namespace, podName, dbCommand string) error ê°™ì€ í•¨ìˆ˜ë¡œ ìº¡ìŠí™”

#### ì´í›„ í”„ë¡œì„¸ìŠ¤

#### Helm Package ìƒì„±

Helm Chartë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ìŒ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•œë‹¤.

```bash
helm package {package-name}

# ì»¤ë§¨ë“œ ê²°ê³¼
Successfully packaged chart and saved it to: /Users/0ds/Documents/GitHub/install-software/{package-name}-1.0.0.tgz
```

ê·¸ëŸ¼ root ê²½ë¡œì— `{package-name}-1.0.0.tgz` íŒŒì¼ì´ ìƒì„±ëœë‹¤.

#### Harbor Repositoryì— Chart íŒŒì¼ push

ìƒì„±ëœ íŒŒì¼ì„ Helm Repositoryë¡œ ì“°ë ¤ëŠ” Harbor ê²½ë¡œë¡œ í‘¸ì‹œí•´ì£¼ì.

```bash
helm push {package-name}-1.0.0.tgz oci://{public-harbor-path}/{project-name}

# ì»¤ë§¨ë“œ ê²°ê³¼
Pushed: {harbor-url}/{project-name}/{package-name}:1.0.0
Digest: sha256:1582fb49c2ad1cecf19037697cc6206014f0b771412f414d86609dc5000c5aa2 # ì‹¤ì œê°’ ì•„ë‹˜
```

ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (í˜„ì¬ëŠ” ë²„ì „ 1.0.0ë¡œ êµ¬ì¶•ëœ ìƒíƒœì´ë‹¤.)

![](https://0biglife-world.s3.us-east-2.amazonaws.com/post24_04.png)

#### Go ì„¤ì¹˜ íŒŒì¼ ìƒì„±

```bash
# For M1/M2 Mac
GOOS=darwin GOARCH=arm64 go build
```

#### Go ì„¤ì¹˜ íŒŒì¼ ì‹¤í–‰

```bash
# íŒŒì¼ ê¶Œí•œ ìˆ˜ì •
chmod +x {install-file-name}

# íŒŒì¼ ì‹¤í–‰ : nks ì¸ì ì „ë‹¬ì„ í†µí•´ naver cloud í™˜ê²½ì— ì†”ë£¨ì…˜ì„ ì„¤ì¹˜í•˜ë„ë¡ ì‹¤í–‰í•œë‹¤
./{install-file-name} nks
```

#### ì„¤ì¹˜ê³¼ì • ëª¨ë‹ˆí„°ë§

ì¢Œì¸¡ ìƒë‹¨ì€ DB í¬íŠ¸ í¬ì›Œë”©í•˜ëŠ” ìš©ë„, ì¢Œì¸¡ í•˜ë‹¨ê³¼ ì¤‘ì•™ì€ ê°ê° ì„¤ì¹˜ ëª¨ë‹ˆí„°ë§ê³¼ íŒŒë“œ ìƒíƒœ ëª¨ë‹ˆí„°ë§, ê·¸ë¦¬ê³  ìš°ì¸¡ì€ ì°¨ë¡€ëŒ€ë¡œ pv, pvc, configmapì´ ë°°í¬ê°€ ì˜ ë˜ê³  ìˆëŠ”ì§€ ëª¨ë‹ˆí„°ë§í•˜ëŠ” í„°ë¯¸ë„ í™”ë©´ì´ë‹¤.

![](https://0biglife-world.s3.us-east-2.amazonaws.com/post24_05.png)

```bash
# port-forward : ë°°í¬ëœ StatefulSet Pod DB ë¥¼ Mongo Compass ì—°ê²°í•˜ëŠ” ìš©ë„
kubectl port-forward {db-pod-name} -n {namespace} 28015:27017

# pod monitoring : watch ì˜µì…˜ ì‚¬ìš©
kubectl get po -A -w

# pv/pvc monitoring : pvëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìœ¼ë‚˜ ìŠµê´€ì²˜ëŸ¼ -A ë‹¬ì•„ë²„ë¦¬ê¸°,,!
kubectl get pv -A -w
kubectl get pvc -A -w

# configmap monitoring
kubectl get configmap -A -w
```

## ë§ˆì¹˜ë©°

`Helm`ì„ í†µí•´ ì‚¬ë‚´ ì„¤ì¹˜ ê³¼ì •ì„ íš¨ìœ¨ì ìœ¼ë¡œ ë°°í¬ ë° ê´€ë¦¬í•˜ëŠ” ë°©ì‹ì— ëŒ€í•´ ë‹¤ë¤˜ë‹¤. ê·¸ ê³¼ì •ì—ì„œ ì—¬íƒœ ë¹ ì ¸ìˆë˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±ê³¼ ì½”ë“œ ì •ë¦¬ê¹Œì§€ ì§„í–‰í•˜ì˜€ë‹¤. ë‹µë‹µí•¨ì´ í•´ì†Œë˜ì—ˆìœ¼ë‚˜ ëŠ˜ ê·¸ë ‡ë“¯ í•˜ë©´ í• ìˆ˜ë¡ ìš•ì‹¬ì´ ìƒê¸°ëŠ” ì‘ì—…ì´ë‹¤. ê¸°ì¡´ì— ì‘ì—…í•´ì˜¤ë©´ì„œ ë¬¸ì„œí™”í•œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸€ì„ ì •ë¦¬í–ˆëŠ”ë° ì¢€ ë” ë‹¤ë“¬ì–´ì•¼í•  ë¶€ë¶„ì´ ë³´ì—¬ ë‹¤ìŒì£¼ì— í‡´ê³ í•´ë³¼ ì˜ˆì •ì´ë‹¤.
